import os
import pandas as pd
import google.generativeai as genai
import logging

api_key = os.environ.get("GEMINI_API_KEY")
if api_key:
    genai.configure(api_key=api_key)
else:
    logging.warning("GEMINI_API_KEY is not set, Gemini features will be disabled.")


def generate_analyst_report(
    ticker_name: str,
    ticker_code: str,
    latest_data_dict: list[dict],
    predictions_dict: list[dict],
) -> str:
    """Return an investment report generated by Gemini."""
    if not api_key or os.environ.get("PYTEST_CURRENT_TEST"):
        return "Gemini API key is not configured."

    latest_data_text = (
        pd.DataFrame(latest_data_dict).to_string(index=False)
        if latest_data_dict
        else "（テクニカル指標データなし）"
    )
    predictions_text = (
        pd.DataFrame(predictions_dict).to_string(index=False)
        if predictions_dict
        else "（モデル予測データなし）"
    )

    reasoning_prompt = f"""
あなたはトップクラスのクオンツ・アナリストです。以下のデータを精査し、投資判断に必要な要点を日本語で箇条書きしてください。

---
### 最新のテクニカル指標
{latest_data_text}

### 機械学習モデルによる予測
{predictions_text}
---
"""

    final_prompt_template = """
先ほどの考察結果を基に、{ticker_name} ({ticker_code}) の投資判断レポートをMarkdown形式でまとめてください。

{reasoning_text}

```markdown
### 投資戦略サマリー：{ticker_name}

| 評価軸 | 分析結果と判断 |
|:---|:---|
| **短期トレンド (1-7日)** | （考察結果から短期トレンドの評価と根拠を抽出して記述） |
| **中期トレンド (28日)** | （考察結果から中期トレンドの評価と根拠を抽出して記述） |
| **短期モデルの信頼性 (1-7日)** | （考察結果から短期モデルの信頼性評価を抽出して記述） |
| **中期モデルの信頼性 (28日)** | （考察結果から中期モデルの信頼性評価を抽出して記述） |
| **総合評価** | （考察結果から総合評価を抽出し、「買い推奨」「様子見」「売り推奨」のいずれかで記述） |

## 4. 具体的な戦略プラン
- **エントリーポイント:** （考察結果からエントリーポイントに関する記述を抽出）
- **ターゲットプライス:** （考察結果からターゲットプライスに関する記述を抽出）
- **ストップロス:** （考察結果からストップロスに関する記述を抽出）
```
"""
    try:
        model = genai.GenerativeModel("gemini-1.5-flash")
        generation_config = genai.types.GenerationConfig(temperature=0.2)

        # ステップ1: 思考
        reasoning_resp = model.generate_content(
            reasoning_prompt, generation_config=generation_config
        )

        # ステップ2: 校正
        final_prompt = final_prompt_template.format(
            ticker_name=ticker_name,
            ticker_code=ticker_code,
            reasoning_text=reasoning_resp.text,
        )

        final_resp = model.generate_content(
            final_prompt, generation_config=generation_config
        )
        return final_resp.text
    except Exception as e:
        return f"Error generating report from Gemini: {e}"
